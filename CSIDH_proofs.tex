
In this section, we discuss two sigma protocols for the natural relation coming from group actions in the specific case of CSIDH~\cite{CSIDH} (see Definition~\ref{defn:R-CSIDH} below).

%Fix a prime $p$ of the form $p = 4\ell_1 \cdots \ell_r -1$, for some integer $r$, where the $\ell_i$ are distinct small odd primes, and we let $E_0/\Field_p$ be the supersingular curve defined by $y^2 = x^3 +x $. Then the $\Field_p$-endomorphism ring of $E_0$ (and that of any curve $\Field_p$-isogenous to $E_0$) is isomorphic to $\mathbb{Z}[\sqrt{-p}]$. (Alternatively, one could work with curves whose $\Field_p$-endomorphism ring is $\mathbb{Z}[(1+\sqrt{-p})/2]$, see \cite{CD20}.) We assume that the class group $\cl(\mathbb{Z}[\sqrt{-p})]$ is generated by the ideal classes of the $r$ ideals of the form $\fl_i = (\ell_i, \sqrt{-p} - 1)$ for $i$ from $1$ to $r$. The class group $\cl(\mathbb{Z}[\sqrt{-p})]$ acts freely and transitively on the set $\Ell$ of $\Field_p$-isomorphism classes of elliptic curves with $\Field_p$-endomorphism ring $\mathbb{Z}[\sqrt{-p}]$, and that we can efficiently compute the action of the ideals classes $\overline{\fl}_1,\cdots,\overline{\fl}_r,$ and their inverses. For a vector $\bx \in \mathbb{Z}^r$ and $E \in \Ell$ we define \[ [\bx]E := \left( \prod_{i=1}^r \overline{\fl}_i^{x_i} \right) \star E  \, , \] where $\star$ is the action of the ideal class group, also known in this setting as the CSIDH action. 

Recall that the action of a vector $\bx \in \mathbb{Z}^r$ on $E \in \Ell$ is defined by \[ [\bx]E := \left( \prod_{i=1}^r {\overline{\fl}_i}^{x_i} \right) \star E  \, , \] where $\star$ is the action of the ideal class group. Note that $\star$ is computed using a sequence of isogenies of degree $\ell_i$ corresponding to the prime ideals $\fl_i$.



\begin{definition} \label{defn:R-CSIDH}
The CSIDH relation is
\[
\R[CSIDH] = \left\{ (E,\bx) \in \Ell \times \mathbb{Z}^r \,\, | \,\, [\bx]E_0 = E \right\}.
\]
\end{definition}


%\WB{reviewer says: I personally would argue adding R CSIDH to the intro is worth it but I admit it's not easy given the definition}
%\SG{I have attempted to give a brief formulation in the intro, so that at least the experts can see what it is easily.}\CP{made another suggestion}

%{\bf GAIP.} The group action inverse problem (GAIP) asks, given $E = [\bx]E_0$ to compute $\bx' \in \mathbb{Z}^r$ (possibly different from $\bx$) such that $[\bx']E_0 = E$. We assume that this problem is hard on average, when $E$ is chosen uniformly at random in $\Ell$, or when it is chosen of the form $[\bx] E_0$, for $\bx$ chosen uniformly at random from a large enough box $\{-B,\dots,B\}^r$ (large enough means $(2B+1)^r \approx \sqrt{p}$). As discussed in \cref{sec:sigma}, if GAIP is indeed hard on average for one of these distributions, then a sigma protocol for $\Rela$ can be turned into a secure signature scheme.

We now describe two sigma protocols for the relation \R[CSIDH]. The first protocol is simpler and more efficient, but it requires knowledge of the structure of the class group $\cl(\mathbb{Z}[\sqrt{-p}])$ and the relations between the ideal classes $\overline{\fl}_i$. This is a big disadvantage because (pre)computing this information is expensive, which means the first protocol can only be used for small parameters, e.g., when the order of the class group is $\approx 2^{256}$, see~\cite{CSI-FiSh}.\footnote{The structure of a class group can be computed in quantum polynomial time, so this protocol could be used with large class groups if anyone with access to a quantum computer is willing to compute a class group and publish the result (which can be verified efficiently with classical algorithms).} The second protocol is less efficient, but it does not require knowledge of the class group, and can thus be used for larger class group actions.  

\subsection{CSI-FiSh sigma protocol}

We will call the first protocol the CSI-FiSh protocol, even though a variant was already known well before the CSI-FiSh paper. It is a straightforward generalization of the graph isomorphism protocol from \cref{sec:GMW} and was already described in the group actions setting by Couveignes~\cite{Couv06},  Rostovstev and Stolbunov~\cite{RosSto}, and in more detail by De Feo and Galbraith in the CSIDH setting~\cite{SeaSign}. An optimization of the protocol that uses quadratic twists was added to the protocol in the CSI-FiSh paper~\cite{CSI-FiSh}.


In this section, we assume\footnote{All the results generalize to the more general case where the class group is not necessarily cyclic.} for simplicity that the class group $\cl(\mathbb{Z}[\sqrt{-p}])$ is cyclic with a generator $\overline{\fg}$ of known order $N$,  and that we know the discrete logarithms $a_1,\dots,a_k$ of the ideal classes $\overline{\fl}_1,\dots,\overline{\fl}_r$ with respect to $\overline{\fg}$. This includes the case of the CSIDH-512 parameter set, proposed by~\cite{CSIDH}, with $r = 74$, and where the first 73 small primes $\ell_1,\dots,\ell_{73}$ are the first 73 odd primes, and where $\ell_{74} = 587$. For this choice of prime $p$, the class group was computed by Beullens, Kleinjung, and Vercauteren~\cite{CSI-FiSh}. It turned out that the class group is cyclic of order \[N = {\scriptstyle 254652442229484275177030186010639202161620514305486423592570860975597611726191 } \, ,\] and that the ideal class of the first ideal $\fl_1 = (3,\sqrt{-p}-1) $ generates the entire class group. The discrete logarithms of the remaining $\overline{\fl}_i$ with $i > 1$, as well as a reduced basis for the relation lattice  \href{https://github.com/KULeuven-COSIC/CSI-FiSh/tree/master/classgroup_data}{are publicly available}.

Given an integer $x \in \mathbb{Z}/ N \mathbb{Z}$ and a curve $E \in \Ell$ we want to compute the action of $\overline{\fg^x}$ on $E$. Naively computing the action of $\overline{\fg}$ a total of $x$ times would require an exponential amount of time, so this is not efficient. Instead, since we know the discrete logarithms $a_i$ such that $\overline{\fg^{a_i}} = \overline{\fl}_i$ for all $i$ from 1 to $r$, we can use lattice algorithms to find a short vector $\bx \in \mathbb{Z}^r$ such that $\sum_{i=1}^r a_i x_i = x \mod N$. Once we have such a vector we can evaluate $[\bx]E$ efficiently. Asymptotically, this could be inefficient, because the lattice algorithms are too slow or produce vectors that are too large, but in practice (at least for the CSIDH-512 parameter set) this is not a problem: for CSIDH-512 the lattice algorithms are much faster than the isogeny computations, and the resulting vector $\bx$ is close to optimal. In total, computing the action of $\overline{\fg^x}$ on $E \in \Ell$ for a random $x \in \mathbb{Z}/ N \mathbb{Z}$ is only 15\% slower than computing $[\bx]E$ for a random $\bx \in [-5,5]^{74}$ (which is done in the CSIDH-512 key exchange protocol). For more details, we refer to~\cite{CSI-FiSh}.

With these details out of the way, we have a group action of $\mathbb{Z}/ N \mathbb{Z}$ on $\Ell$ (instead of a group action of $\mathbb{Z}^r$). With a mild abuse of notation, we denote the action of $x \in \mathbb{Z}/ N \mathbb{Z}$ on $E \in \Ell$ also by $[x]E$. \Cref{fig:csi-FiSh} shows the CSI-FiSh sigma protocol, which is an adaptation of the sigma protocol for graph isomorphism to this group action (replacing the action of $S_n$ on graphs of order $n$ by the action of $\mathbb{Z}/ N \mathbb{Z}$ on $\Ell$). However, a difference is that we can make the challenge space slightly larger ($\{-1,0,1\}$ instead of $\{0,1\}$), by exploiting the fact that if $E^t$ is the quadratic twist of $E = [x]E_0$, then $E^t$ is $\Field_p$-isomorphic to $[-x]E_0$. A cheating prover who does not know $x$ can win each round with probability $1/3$. The proofs that this sigma protocol is complete, 2-special sound for the relation $\R[CSIDH]$,  and honest-verifier zero-knowledge are 
straightforward; 
we refer to~\cite{CSI-FiSh}.

\begin{figure}
    \centering
    \begin{adjustbox}{minipage=0.95\linewidth,fbox,center}
    \begin{tabularx}{\textwidth}{bsB}
    \multicolumn{1}{c}{{\bf Prover}(($E,x$))} &  & \multicolumn{1}{c}{{\bf Verifier}($E$)} \\
    \\
    \quad $b \gets \mathbb{Z}/ N \mathbb{Z}$ \\
    \quad $E' \gets [b]E_0$ & & \\
     &  \multicolumn{1}{c}{ $\xrightarrow{\quad E' \quad } $ }  & \\
     & & \quad $c \gets \{-1,0,1\}$ \\
     & \multicolumn{1}{c}{ $\xleftarrow{\quad c \quad } $ } & \\ 
    \quad $r \gets b - cx \mod{N}$ & & \\
    & \multicolumn{1}{c}{ $\xrightarrow{\quad r \quad }$} & \\
    & & \quad {\bf If $c = -1$:} \\
    & & \quad \quad {\bf return} $E' = [r]E^t$ \\
    & & \quad {\bf If $c = 0$:} \\ 
    & & \quad \quad {\bf return} $E' = [r]E_0$  \\
    & & \quad {\bf If $c = 1$:} \\
    & & \quad \quad {\bf return} $E' = [r]E$ 
    \end{tabularx}
    \end{adjustbox}
    \caption{The CSI-FiSh sigma protocol. Here, and in subsequent figures, the equal sign denotes the equality predicate and the return statements return either true or false.}
    \label{fig:csi-FiSh}
\end{figure}


\subsection{CSI-FiSh non-interactive proofs/signatures}

We can obtain a non-interactive proof for the CSIDH relation by applying the Fiat-Shamir transform to the sigma protocol of \cref{fig:csi-FiSh}, after amplifying the soundness. The resulting protocol is called CSI-FiSh (Commutative Supersingular Isogeny Fiat-Shamir). Since the base sigma protocol has a challenge space of size 3, we need to repeat the protocol $k = \lceil \lambda/\log3 \rceil$ times to get $\lambda$ bits of security. Note that the verifier can compute the $E'$ himself, so they do not need to be included in the proof. Therefore, a proof is of the form $\sigma = \{ c^{(i)},r^{(i)} \}_{i \in [k]}$. For $\lambda$ bits of classical security, we need $N \approx 2^{2\lambda}$, so the total proof size is \[
k ( 2 + 2\lambda ) \approx 1.26 \lambda^2 \text{ bits} \, .
\]

We can use this non-interactive proof as a signature scheme. However, if the goal is to obtain efficient signatures, it is possible to significantly reduce the signature size at the cost of increasing the size of the public keys.

{\bf Protocol with larger challenge space.} \label{sec:multiple_keys} In a nutshell, the idea is that instead of letting the public key be a single curve $E$, we let the public key consist of $S$ curves $E_1 = [x_1]E_0, \dots, E_S = [x_S]E_0$, where the $x_1, \dots, x_S$ are the new secret key. The new sigma protocol is similar to that of \cref{fig:csi-FiSh}, but has a challenge space $\{-S,\dots,S\}$ (of size $2S+1$), and in response to challenge $c$, the prover sends a response $r$, such that $[r]E_c = E'$ if ($c \ge 0$), or such that $[r]E_{-c}^t = E'$ in case $c \leq 0$. 
One can show in the random oracle model that a forger against this protocol can be turned into an algorithm that takes as input the curves $E_1, \dots, E_S$ and outputs a triple $(i,j,x)$ such that $1 \le i < j \le S$ and $[x]E_i = E_j$; this is believed to be a hard problem but it is not the problem of computing a witness for the relation $\R[CSIDH]$ so the protocol is not a proof of knowledge for this relation.
The advantage of this sigma protocol is that the challenge space is larger, so the protocol only needs to be repeated $\lambda/\log(2S+1)$ times for soundness error $2^{-\lambda}$. The signature size of the new signature is approximately \[
\frac{2}{\log(2S+1)} \lambda^2 \text{ bits} \,.
\]
However, the size of the public key is now $4S \lambda$. So the parameter $S$ gives a trade-off between small signatures (large $S$) and small public keys (small $S$). For more details (and a technique based on Merkle trees to reduce the size of the public key) we refer to the SeaSign or CSI-FiSh papers~\cite{SeaSign,CSI-FiSh}.


\iffalse
{
\color{gray}
{\bf Protocol with larger challenge space.} \label{sec:multiple_keys}
[WARD: I think we discussed that we would not talk about this, so I'll summarize this in one or two sentences.] 

In a nutshell, the idea is that instead of letting the public key be a single curve $E$, we let the public key consist of $S$ curves $E_1 = [x_1]E_0, \dots, E_S = [x_S]E_0$. The new sigma protocol is similar to that of \cref{fig:csi-FiSh}, but has a challenge space $\{-S,\dots,S\}$ (of size $2S+1$), and in response to challenge $c$, the prover sends a response $r$, such that $[r]E_c = E'$ if ($c \ge 0$), or such that $[r]E_{-c}^t = E'$ in case $c \leq 0$. One can check that this is a correct and honest-verifier zero-knowledge sigma protocol for the relation \[
\Rela^S  = \left \{ ((E_1,\dots,E_S),(x_1,\dots,x_S)) \,\, \middle | \,\, [x_i]E_0 = E_i \quad  \forall i \in \{1,\dots,S\} \right \} \,.
\]
Moreover, this protocol has relaxed special soundness   for the relaxed relation \[
{\Rela'}^S = \left \{ ((E_1,\dots,E_S),(x_1,i,j)) \,\, \middle | \,\, ([x]E_i = E_j \vee [x]E_i = E^t_j) \quad \wedge \quad i \ne j \right \} \,,
\] because given two accepting transcripts of the protocol, one can recover $x$ such that $[x]E_i = E_j$ or $[x]E_i = E^t_j$ for some $i \neq j \in \{0, \dots, S\}$. One can prove that breaking the relaxed relation is equally hard as breaking the group action inverse problem (GAIP). This means that applying the Fiat-Shamir protocol to the new sigma protocol results in a secure signature scheme. (Because if someone could forge signatures, they could solve GAIP, which is assumed to be difficult). 

The advantage of this sigma protocol is that the challenge space is larger, so the protocol only needs to be repeated $\lambda/\log(2S+1)$ times. The signature size of the new signature is approximately \[
\frac{2}{\log(2S+1)} \lambda^2 \text{ bits} \,.
\]

However, the size of the public key is now $4S \lambda$. So the parameter $S$ gives a trade-off between small signatures (large $S$) and small public keys (small $S$). For more details (and a technique based on Merkle trees to reduce the size of the public key) we refer to the SeaSign or CSI-FiSh papers~\cite{SeaSign,CSI-FiSh}.

}
\fi

\subsection{SeaSign sigma protocol}

If the structure of the class group of $\mathbb{Z}[\sqrt{-p}]$ is not known, then we cannot efficiently compute the action of $\mathbb{Z}/N \mathbb{Z}$ on $\Ell$, so we cannot directly use the CSI-FiSh protocol. The naive way to solve this problem would be to just work with the action of $\mathbb{Z}^r$ instead: To prove knowledge of $\bx$ such that $E = [\bx]E_0$, the prover picks $\bb \in [-B,B]^r$ uniformly at random and sends $[\bb]E_0$ to the verifier, who responds with a challenge $c \in \{-1,0,1\}$, and then the prover sends his response $\br = \bb - c\bx$. Unfortunately, this sigma protocol is not zero knowledge, because in the case $c = 1$, the response is biased towards $-\bx$, and if $c = -1$, the response is biased towards $\bx$. After observing a number of executions of the protocol, an attacker could just compute the average of $- c \br$ to get a good estimate of $\bx$.

In the CSI-FiSh case we chose $b$ uniformly at random, so the response $r = b + cx \mod N$ does not reveal information about $x$. In the new protocol, since $\mathbb{Z}^r$ is infinite, we cannot choose $\bb$ uniformly at random, so the response $\br = \bb + c \bx$ leaks information about $\bx$.



One approach to  the problem is to sample $\bb$ from a box $[-\delta B,\delta B]^r$ where $\delta > 1$, which is larger than the box $[-B,B]^r$ from which the secret $\bx$ is sampled. The hope is that if $\delta B$ is much larger than $B$, then the distribution of $\bb + \bx$ is close to the distribution of $\bb$, so it does not leak information about $\bx$. Unfortunately, to make the two distributions indistinguishable $\delta B$ would need to be exponentially larger than $B$. This is impractical because then evaluating the action of $[\bb]E_0$ would take an exponential amount of time.

However the following observation can help us: The response $\br = \bb - c \bx$ can take values in $[-(\delta + 1)B,(\delta + 1)B]$, but $\br$ only leaks information about $\bx$ if $\br$ is close to the boundary of this box. For example, if in the $c = 1$ case one of the coefficients $r_i$ is equal to $-(\delta+1)B$, then this reveals that $x_i = -B$. Conversely, if $\br$ is sufficiently far away from the boundary, then it does not leak information: If $\br \in [-(\delta-1) B, (\delta-1) B]^r$ (which happens with probability $\left( \frac{2(\delta-1) B+1}{2\delta B+1} \right)^r \approx \left(1 - \frac{1}{\delta}\right)^r$), then all values of $\bx$ are consistent with $\br$, and the probability of seeing the response $\br$ is independent of $\bx$, so $\br$ does not reveal any information about $\bx$. 

Using this observation, we can design a sigma protocol with aborts (a concept introduced by Lyubashevsky~\cite{FSWithAborts}) as follows: we pick $\delta$ large enough such that with reasonably large probability (e.g. at least $1/2$), the response $\br$ lies in the ``safe'' box $[-(\delta-1) B, (\delta-1) B]^r$. Before the prover sends a response $\br$ they first check if $\br$ lies in $[-(\delta-1) B, (\delta-1) B]^r$. If this is the case, then the prover sends the response to the verifier, and otherwise, the prover aborts the sigma protocol to avoid leaking information. This way, we guarantee that the responses do not leak any information about $\bx$. 

The protocol is summarized in \cref{fig:SeaSign}. We can prove that the protocol aborts with probability $\epsilon$ close to $1-\left(1-\frac{1}{\delta} \right)^r$, that the protocol is correct (i.e. if in an honest execution the prover does not abort, then the verifier will accept), that the protocol has special soundness, and that the protocol has non-abort honest verifier zero-knowledge, meaning that non-aborting transcripts of the protocol can be simulated without knowledge of $\bx$.

\begin{figure}
    \centering
    \begin{adjustbox}{minipage=\linewidth,fbox,center}

    \begin{tabularx}{\textwidth}{Bsb}
    \multicolumn{1}{c}{{\bf Prover}(($E,\bx$))} &  & \multicolumn{1}{c}{{\bf Verifier}($E$)} \\
    \\
    \quad $\bb \gets [-\delta B, \delta B]^r $ \\
    \quad $E' \gets [\bb]E_0$ & & \\
     &  \multicolumn{1}{c}{ $\xrightarrow{\quad E' \quad } $ }  & \\
     & & \quad $c \gets \{-1,0,1\}$ \\
     & \multicolumn{1}{c}{ $\xleftarrow{\quad c \quad } $ } & \\ 
    \quad $\br \gets \bb - c\bx$ & & \\
    \quad {\bf If $\br \not \in [-(\delta-1)B,(\delta-1)B]^r$:} && \\
    \quad \quad Prover aborts & & \\
    & \multicolumn{1}{c}{ $\xrightarrow{\quad \br \quad }$} & \\
    & & \quad {\bf If $c = -1$:} \\
    & & \quad \quad {\bf return} $E' = [\br]E^t$ \\
    & & \quad {\bf If $c = 0$:} \\ 
    & & \quad \quad {\bf return} $E' = [\br]E_0$  \\
    & & \quad {\bf If $c = 1$:} \\
    & & \quad \quad {\bf return} $E' = [\br]E$ 
    \end{tabularx}
    \end{adjustbox}
    \caption{The SeaSign sigma protocol with abort.}
    \label{fig:SeaSign}
\end{figure}


\subsection{SeaSign non-interactive proofs/signatures.}

Just like with a normal sigma protocol, the soundness of a sigma protocol with abort can be amplified by repeating the protocol $k = \lceil \lambda / \log 3 \rceil$ times in parallel. However, this increases the probability of an abort from $\epsilon$ to $1-(1-\epsilon)^k$. We can choose $\delta = kr$, such that the probability that none of the $k$ repetitions of the sigma protocols abort is approximately $(1-\frac{1}{\delta})^{kr} \approx 1/e$.

Then, we can transform the amplified sigma protocol into a signature scheme with the Fiat-Shamir transform. If during the generation of a signature the prover aborts, then the signer can just restart the signing algorithm. As long as the success probability is not too small (e.g., $\approx 1/e$ if $\delta = kr$) the signing algorithm will succeed after a reasonable number of attempts.

{\bf Optimizing SeaSign.} The technique of using multiple curves in the public key, which we described in \cref{sec:multiple_keys} can also be used to reduce the signature size of SeaSign (at the cost of larger keys). In fact, this technique was introduced in the SeaSign paper.

Note that if $c=0$, then the response is just $\br = \bb$, which does not leak information about $\bx$. Therefore, the prover does not need to abort if $\br$ lies outside of the ``safe'' box $[-(\delta-1)B,(\delta-1)B]^r$. This optimization reduces the rate of aborts, which means we can reduce $\delta$, which in turn makes the signing algorithms faster (and the signatures slightly smaller). This optimization was described in a paper by Decru, Panny, and Vercauteren~\cite{FasterSeaSign}, along with some additional optimizations which are beyond the scope of this survey.